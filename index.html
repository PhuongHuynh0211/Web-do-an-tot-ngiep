<html class="scroll-smooth" lang="vi">
<head>
  <meta charset="utf-8"/>
  <meta content="width=device-width, initial-scale=1" name="viewport"/>
  <title>Điều khiển và giám sát hệ thống Chiller</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css" rel="stylesheet"/>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&amp;display=swap" rel="stylesheet"/>
  <script type="text/javascript" src="https://www.gstatic.com/charts/loader.js"></script>
  <script src="https://www.unpkg.com/@eohjsc/era-widget@1.1.3/src/index.js"></script>
  <style>
    body {
      font-family: 'Inter', sans-serif;
    }
    .loading-text::after {
      content: "...";
      animation: loading-dots 1s infinite;
    }
    @keyframes loading-dots {
      0%, 20% { content: "."; }
      40% { content: ".."; }
      60%, 100% { content: "..."; }
    }
    .status-led {
      width: 0.75rem; 
      height: 0.75rem; 
      border-radius: 50%;
      transition: background-color 0.3s ease, border-color 0.3s ease;
    }
    .led-off {
      background-color: transparent;
      border: 1.5px solid #d1d5db; 
    }
    .led-on {
      background-color: #10b981; 
      border: 1.5px solid #059669; 
    }
    .google-chart-container {
        width: 100%;
        height: 250px; 
    }
    .gauge-container-google {
        width: 100%; 
        max-width: 150px; 
        height: 100px; 
        margin: auto; 
    }
    @media (min-width: 640px) { 
        .gauge-container-google {
            height: 120px;
        }
    }
     @media (min-width: 1024px) { 
        .gauge-container-google {
            height: 140px; 
        }
    }
  </style>
</head>
<body class="bg-gray-100 min-h-screen flex flex-col">
  <header class="bg-white shadow-md sticky top-0 z-30">
    <div class="max-w-full mx-auto px-2 sm:px-4 lg:px-6 flex items-center justify-between h-16">
      <div class="flex items-center space-x-2 sm:space-x-3">
        <img alt="Logo HCMUTE" class="w-8 h-8 sm:w-10 sm:h-10 rounded object-contain" src="Logo_hcmute.png"/>
        <h1 class="text-lg sm:text-xl font-semibold text-gray-800">
          Điều khiển và giám sát hệ thống Chiller
        </h1>
      </div>
      <div class="flex items-center">
        <nav class="hidden md:flex space-x-4 lg:space-x-6 text-gray-600 font-medium mr-3 lg:mr-6">
          <a class="hover:text-blue-600 transition text-sm sm:text-base" href="#sensors">
            Cảm biến
          </a>
          <a class="hover:text-blue-600 transition text-sm sm:text-base" href="#controls">
            Điều khiển
          </a>
        </nav>
        <button aria-label="Chuyển đổi chế độ Toàn màn hình" class="text-gray-600 hover:text-blue-600 focus:outline-none focus:ring-2 focus:ring-blue-500 mr-2 sm:mr-4" id="fullscreen-btn" title="Toàn màn hình">
          <i class="fas fa-expand fa-lg"></i>
        </button>
        <button aria-label="Mở menu" class="md:hidden text-gray-600 focus:outline-none focus:ring-2 focus:ring-blue-500" id="menu-btn">
          <i class="fas fa-bars fa-lg">
          </i>
        </button>
      </div>
    </div>
    <nav aria-label="Mobile menu" class="md:hidden bg-white border-t border-gray-200 hidden" id="mobile-menu">
      <a class="block px-4 py-3 text-gray-700 hover:bg-blue-50 hover:text-blue-600 transition" href="#controls">
        Điều khiển
      </a>
      <a class="block px-4 py-3 text-gray-700 hover:bg-blue-50 hover:text-blue-600 transition" href="#sensors">
        Cảm biến
      </a>
    </nav>
  </header>
  <main class="flex-grow max-w-full mx-auto px-2 sm:px-4 lg:px-6 py-4 sm:py-8 w-full">
    <div class="flex flex-col md:flex-row md:space-x-4 lg:space-x-6">
      
      <section class="w-full md:w-2/5 lg:w-1/3 bg-white rounded-lg shadow p-3 sm:p-4 mb-6 md:mb-0 flex flex-col" id="controls">
        <h2 class="text-lg sm:text-xl font-semibold text-gray-800 mb-3 sm:mb-4 flex items-center">
          <i class="fas fa-cogs mr-2 text-green-600"></i>
          Điều khiển thiết bị
        </h2>
        <div class="grid grid-cols-1 sm:grid-cols-2 gap-3 sm:gap-4 flex-grow">
          <div class="border border-gray-200 rounded-lg p-2 sm:p-3 bg-gray-50 flex flex-col items-center relative">
            <img alt="Hình ảnh máy bơm nước" class="mb-1 sm:mb-2 rounded-md h-20 w-20 sm:h-24 sm:w-24 object-contain" src="water-pump.png"/>
            <div class="status-led led-off absolute top-1 right-1 sm:top-2 sm:right-2" id="pump-led">
            </div>
            <h3 class="text-base sm:text-lg font-semibold text-gray-700 mb-2 sm:mb-3">
              Máy bơm
            </h3>
            <button aria-pressed="false" class="w-full max-w-[120px] sm:w-28 py-1.5 sm:py-2 rounded-md text-white bg-gray-400 cursor-not-allowed text-xs sm:text-sm" disabled id="pump-toggle">
              Chờ cấu hình
            </button>
          </div>
          <div class="border border-gray-200 rounded-lg p-2 sm:p-3 bg-gray-50 flex flex-col items-center relative">
            <img alt="Hình ảnh máy nén khí" class="mb-1 sm:mb-2 rounded-md h-20 w-20 sm:h-24 sm:w-24 object-contain" src="air-compressor.png"/>
            <div class="status-led led-off absolute top-1 right-1 sm:top-2 sm:right-2" id="compressor-led">
            </div>
            <h3 class="text-base sm:text-lg font-semibold text-gray-700 mb-2 sm:mb-3">
              Máy nén
            </h3>
            <button aria-pressed="false" class="w-full max-w-[120px] sm:w-28 py-1.5 sm:py-2 rounded-md text-white bg-gray-400 cursor-not-allowed text-xs sm:text-sm" disabled id="compressor-toggle">
              Chờ cấu hình
            </button>
          </div>
          <div class="border border-gray-200 rounded-lg p-2 sm:p-3 bg-gray-50 flex flex-col items-center">
            <img alt="Hình ảnh biến tần năng lượng mặt trời" class="mb-2 sm:mb-3 rounded-md h-20 w-20 sm:h-24 sm:w-24 object-contain" src="solar-inverter.png"/>
            <h3 class="text-base sm:text-lg font-semibold text-gray-700 mb-2 sm:mb-3">
              Biến tần
            </h3>
            <button aria-pressed="false" class="w-full max-w-[120px] sm:w-28 py-1.5 sm:py-2 rounded-md text-white bg-gray-400 cursor-not-allowed text-xs sm:text-sm mb-2 sm:mb-3" disabled id="inverter-toggle">
              Chờ cấu hình
            </button>
            <form aria-label="Form cài đặt tần số biến tần" class="flex flex-col space-y-2 w-full max-w-[200px] sm:max-w-xs" id="frequency-form" onsubmit="return false;">
              <label class="text-gray-700 font-semibold text-sm sm:text-base" for="frequency-input"> 
                Cài đặt tần số (Hz)
              </label>
              <input aria-required="true" class="px-2 py-1 sm:px-3 sm:py-1.5 border border-gray-300 rounded-md focus:outline-none focus:ring-1 focus:ring-purple-500 focus:border-transparent text-xs sm:text-sm" disabled id="frequency-input" max="50" min="0" name="frequency" placeholder="VD: 45,75" required step="0.01" type="number"/>
              <p class="text-xs text-gray-600 mt-1">Hiện tại: <span id="current-frequency-display">--</span> Hz</p>
              <button class="w-full py-1.5 sm:py-2 rounded-md bg-gray-400 text-white font-semibold cursor-not-allowed text-xs sm:text-sm mt-1" disabled id="frequency-submit" type="submit">
                Gửi giá trị
              </button>
              <p class="text-xs sm:text-sm font-medium hidden" id="frequency-feedback">
              </p>
            </form>
          </div>
           <div class="border border-gray-200 rounded-lg p-2 sm:p-3 bg-gray-50 flex flex-col items-center">
            <img alt="Hình ảnh van dầu" class="mb-2 sm:mb-3 rounded-md h-20 w-20 sm:h-24 sm:w-24 object-contain" src="oil-valve.png"/>
            <h3 class="text-base sm:text-lg font-semibold text-gray-700 mb-2 sm:mb-3">
              Van điện
            </h3>
            <form aria-label="Form cài đặt tỷ lệ van điện" class="flex flex-col space-y-2 w-full max-w-[200px] sm:max-w-xs" id="valve-form" onsubmit="return false;">
              <label class="text-gray-700 font-semibold text-sm sm:text-base" for="valve-percentage-input"> 
                Tỷ lệ mở van (%)
              </label>
              <input aria-required="true" class="px-2 py-1 sm:px-3 sm:py-1.5 border border-gray-300 rounded-md focus:outline-none focus:ring-1 focus:ring-blue-500 focus:border-transparent text-xs sm:text-sm" disabled id="valve-percentage-input" max="100" min="0" name="valve-percentage" placeholder="0 - 100" required step="1" type="number"/>
               <p class="text-xs text-gray-600 mt-1">Hiện tại: <span id="current-valve-percentage-display">--</span> %</p>
              <button class="w-full py-1.5 sm:py-2 rounded-md bg-gray-400 text-white font-semibold cursor-not-allowed text-xs sm:text-sm mt-1" disabled id="valve-submit" type="submit">
                Gửi giá trị
              </button>
              <p class="text-xs sm:text-sm font-medium hidden" id="valve-feedback">
              </p>
            </form>
          </div>
        </div>
      </section>
      <section class="w-full md:w-3/5 lg:w-2/3 bg-white rounded-lg shadow p-3 sm:p-5 flex flex-col" id="sensors">
        <h2 class="text-lg sm:text-2xl font-semibold text-gray-800 mb-3 sm:mb-5 flex items-center">
          <i class="fas fa-thermometer-half mr-2 sm:mr-3 text-red-500">
          </i>
          Cảm biến nhiệt độ &amp; áp suất (
          <span class="text-xs sm:text-sm text-gray-500" id="era-status">
            Đang kết nối ERA...
          </span>
          )
        </h2>
        <div class="grid grid-cols-1 sm:grid-cols-2 gap-3 sm:gap-6">
          <div class="border border-gray-200 rounded-lg p-2 sm:p-4 bg-gray-50">
            <h3 class="text-base sm:text-lg font-semibold text-gray-700 mb-2 sm:mb-3 text-center">
              Đường ống nước cấp
            </h3>
            <div class="flex flex-col xl:flex-row justify-around items-center xl:items-start">
              <div class="flex flex-col items-center w-full xl:w-5/12 mb-2 xl:mb-0">
                <div id="gauge-temp-in-google" class="gauge-container-google"></div>
                <p class="text-xs sm:text-sm text-gray-800 mt-1 text-center">Nhiệt độ (°C)</p>
              </div>
              <div class="flex flex-col items-center w-full xl:w-5/12">
                <div id="gauge-pressure-in-google" class="gauge-container-google"></div>
                <p class="text-xs sm:text-sm text-gray-800 mt-1 text-center">Áp suất (bar)</p>
              </div>
            </div>
          </div>
          <div class="border border-gray-200 rounded-lg p-2 sm:p-4 bg-gray-50">
            <h3 class="text-base sm:text-lg font-semibold text-gray-700 mb-2 sm:mb-3 text-center">
              Đường ống nước hồi
            </h3>
            <div class="flex flex-col xl:flex-row justify-around items-center xl:items-start">
              <div class="flex flex-col items-center w-full xl:w-5/12 mb-2 xl:mb-0">
                <div id="gauge-temp-out-google" class="gauge-container-google"></div>
                <p class="text-xs sm:text-sm text-gray-800 mt-1 text-center">Nhiệt độ (°C)</p>
              </div>
              <div class="flex flex-col items-center w-full xl:w-5/12">
                <div id="gauge-pressure-out-google" class="gauge-container-google"></div>
                <p class="text-xs sm:text-sm text-gray-800 mt-1 text-center">Áp suất (bar)</p>
              </div>
            </div>
          </div>
        </div>
        <div class="mt-4 sm:mt-8 grid grid-cols-1 md:grid-cols-2 gap-4 sm:gap-8">
          <div class="bg-white border border-gray-200 rounded-lg p-2 sm:p-4 shadow">
            <h3 class="text-base sm:text-lg font-semibold text-gray-800 mb-2 sm:mb-3"> 
              Biểu đồ nhiệt độ (°C)
            </h3>
            <div id="google_temp_chart_div" class="google-chart-container"></div>
          </div>
          <div class="bg-white border border-gray-200 rounded-lg p-2 sm:p-4 shadow">
            <h3 class="text-base sm:text-lg font-semibold text-gray-800 mb-2 sm:mb-3"> 
              Biểu đồ áp suất (bar)
            </h3>
            <div id="google_pressure_chart_div" class="google-chart-container"></div>
          </div>
        </div>
      </section>
    </div>
  </main>
  <footer class="bg-white border-t border-gray-200 py-3 sm:py-4 text-center text-xs sm:text-sm text-gray-600">
    <p class="text-gray-500">
      © 2025 HCMUTE.
    </p>
    <p class="text-gray-500">
      Huỳnh Trần Phương - 21142153
    </p>
    <p class="text-gray-500">
      Phạm Gia Long - 21142552
    </p>
  </footer>
  <script>
    // Debounce function
    function debounce(func, wait, immediate) { /* ... (giữ nguyên) ... */ let timeout; return function() { const context = this, args = arguments; const later = function() { timeout = null; if (!immediate) func.apply(context, args); }; const callNow = immediate && !timeout; clearTimeout(timeout); timeout = setTimeout(later, wait); if (callNow) func.apply(context, args); }; }

    // Mobile Menu Toggle
    const menuBtn = document.getElementById('menu-btn');
    const mobileMenu = document.getElementById('mobile-menu');
    if (menuBtn && mobileMenu) { /* ... (giữ nguyên) ... */ menuBtn.addEventListener('click', () => { mobileMenu.classList.toggle('hidden'); }); }

    // Fullscreen Toggle
    const fullscreenBtn = document.getElementById('fullscreen-btn');
    if (fullscreenBtn) { /* ... (giữ nguyên) ... */ const fullscreenIcon = fullscreenBtn.querySelector('i'); function getFullscreenElement() { return document.fullscreenElement || document.webkitFullscreenElement || document.mozFullScreenElement || document.msFullscreenElement; } function requestFullscreen(element) { if (element.requestFullscreen) { element.requestFullscreen(); } else if (element.webkitRequestFullscreen) { element.webkitRequestFullscreen(); } else if (element.mozRequestFullScreen) { element.mozRequestFullScreen(); } else if (element.msRequestFullscreen) { element.msRequestFullscreen(); } } function exitFullscreenDocument() { if (document.exitFullscreen) { document.exitFullscreen(); } else if (document.webkitExitFullscreen) { document.webkitExitFullscreen(); } else if (document.mozCancelFullScreen) { document.mozCancelFullScreen(); } else if (document.msExitFullscreen) { document.msExitFullscreen(); } } function updateFullscreenButtonVisuals() { if (getFullscreenElement()) { fullscreenIcon.classList.remove('fa-expand'); fullscreenIcon.classList.add('fa-compress'); fullscreenBtn.setAttribute('aria-label', 'Thoát toàn màn hình'); fullscreenBtn.setAttribute('title', 'Thoát toàn màn hình'); } else { fullscreenIcon.classList.remove('fa-compress'); fullscreenIcon.classList.add('fa-expand'); fullscreenBtn.setAttribute('aria-label', 'Mở toàn màn hình'); fullscreenBtn.setAttribute('title', 'Mở toàn màn hình'); } } fullscreenBtn.addEventListener('click', () => { if (getFullscreenElement()) { exitFullscreenDocument(); } else { requestFullscreen(document.documentElement); } }); document.addEventListener('fullscreenchange', updateFullscreenButtonVisuals); document.addEventListener('webkitfullscreenchange', updateFullscreenButtonVisuals); document.addEventListener('mozfullscreenchange', updateFullscreenButtonVisuals); document.addEventListener('MSFullscreenChange', updateFullscreenButtonVisuals); }

    // DOM Elements for ERA Widget
    const eraStatusEl = document.getElementById('era-status');
    const pumpBtn = document.getElementById('pump-toggle');
    const compressorBtn = document.getElementById('compressor-toggle');
    const inverterBtn = document.getElementById('inverter-toggle');
    
    const frequencyForm = document.getElementById('frequency-form');
    const frequencyInput = document.getElementById('frequency-input'); 
    const frequencySubmitBtn = document.getElementById('frequency-submit');
    const frequencyFeedbackEl = document.getElementById('frequency-feedback');
    const currentFrequencyDisplayEl = document.getElementById('current-frequency-display'); 
    
    const pumpLedEl = document.getElementById('pump-led');
    const compressorLedEl = document.getElementById('compressor-led');
    
    const valveForm = document.getElementById('valve-form');
    const valvePercentageInput = document.getElementById('valve-percentage-input'); 
    const valveSubmitBtn = document.getElementById('valve-submit');
    const valveFeedbackEl = document.getElementById('valve-feedback');
    const currentValvePercentageDisplayEl = document.getElementById('current-valve-percentage-display');


    // Google Gauge Chart variables
    let googleGaugeTempIn, googleGaugePressureIn, googleGaugeTempOut, googleGaugePressureOut;
    let dataTempInGauge, dataPressureInGauge, dataTempOutGauge, dataPressureOutGauge; 
    let optionsGaugeTemp, optionsGaugePressure;

    // Google Line Chart variables
    let googleTempLineChart, googlePressureLineChart;
    let dataGoogleTempLine, dataGooglePressureLine;
    let baseOptionsGoogleLineChart; 
    let updateOptionsGoogleLineChart;

    const maxDataPointsForLineChart = 20; 
    const chartTextColor = '#000000'; 

    let latestTempIn = 0;
    let latestPressureIn = 0;
    let latestTempOut = 0;
    let latestPressureOut = 0;
    let lineChartUpdateInterval; 

    google.charts.load('current', {'packages':['gauge', 'corechart']});
    google.charts.setOnLoadCallback(drawAllGoogleCharts);

    function drawAllGoogleCharts() {
        drawGaugeCharts();
        initializeLineCharts();
        if (lineChartUpdateInterval) clearInterval(lineChartUpdateInterval); 
        lineChartUpdateInterval = setInterval(updateLineChartsPeriodically, 10000); 
    }
    
    function getGaugeChartWidth() { const container = document.getElementById('gauge-temp-in-google'); if (container) { return Math.max(80, container.offsetWidth - 10); } return 120; }

    function drawGaugeCharts() { const gaugeWidth = getGaugeChartWidth(); const commonGaugeOptions = { width: gaugeWidth, height: gaugeWidth * 0.8, minorTicks: 5, animation:{ duration: 500, easing: 'inAndOut' } }; dataTempInGauge = google.visualization.arrayToDataTable([ ['Label', 'Value'], ['°C', 0] ]); optionsGaugeTemp = { ...commonGaugeOptions, redFrom: 50, redTo: 60, yellowFrom: 40, yellowTo: 50, min: 0, max: 60 }; if(document.getElementById('gauge-temp-in-google')) { googleGaugeTempIn = new google.visualization.Gauge(document.getElementById('gauge-temp-in-google')); googleGaugeTempIn.draw(dataTempInGauge, optionsGaugeTemp); } dataPressureInGauge = google.visualization.arrayToDataTable([ ['Label', 'Value'], ['bar', 0] ]); optionsGaugePressure = { ...commonGaugeOptions, redFrom: 12, redTo: 15, yellowFrom: 10, yellowTo: 12, min: 0, max: 15 }; if(document.getElementById('gauge-pressure-in-google')) { googleGaugePressureIn = new google.visualization.Gauge(document.getElementById('gauge-pressure-in-google')); googleGaugePressureIn.draw(dataPressureInGauge, optionsGaugePressure); } dataTempOutGauge = google.visualization.arrayToDataTable([ ['Label', 'Value'], ['°C', 0] ]); if(document.getElementById('gauge-temp-out-google')) { googleGaugeTempOut = new google.visualization.Gauge(document.getElementById('gauge-temp-out-google')); googleGaugeTempOut.draw(dataTempOutGauge, optionsGaugeTemp); } dataPressureOutGauge = google.visualization.arrayToDataTable([ ['Label', 'Value'], ['bar', 0] ]); if(document.getElementById('gauge-pressure-out-google')) { googleGaugePressureOut = new google.visualization.Gauge(document.getElementById('gauge-pressure-out-google')); googleGaugePressureOut.draw(dataPressureOutGauge, optionsGaugePressure); } }
    
    function initializeLineCharts() { 
        const lineChartContainerTemp = document.getElementById('google_temp_chart_div'); 
        const lineChartContainerPressure = document.getElementById('google_pressure_chart_div'); 
        
        baseOptionsGoogleLineChart = { 
            curveType: 'function', 
            legend: { position: 'bottom', textStyle: { color: chartTextColor, fontSize: 12 } }, 
            hAxis: { title: 'Thời gian', textStyle: { color: chartTextColor, fontSize: 11 }, titleTextStyle: { color: chartTextColor, fontSize: 12 } }, 
            vAxis: { textStyle: { color: chartTextColor, fontSize: 10 }, titleTextStyle: { color: chartTextColor, fontSize: 11 } }, 
            titleTextStyle: { color: chartTextColor, fontSize: 12 }, 
            backgroundColor: 'transparent', 
            chartArea: { width: '80%', height: '65%' }, 
            animation:{ duration: 500, easing: 'inAndOut', startup: true },
            width: lineChartContainerTemp ? lineChartContainerTemp.offsetWidth : 300, 
            height: 230 
        };

        updateOptionsGoogleLineChart = { 
            ...baseOptionsGoogleLineChart,
            animation:{ duration: 500, easing: 'inAndOut', startup: false } 
        };

        dataGoogleTempLine = new google.visualization.DataTable(); 
        dataGoogleTempLine.addColumn('string', 'Thời gian'); 
        dataGoogleTempLine.addColumn('number', 'Nước cấp (°C)'); 
        dataGoogleTempLine.addColumn('number', 'Nước hồi (°C)'); 
        if(lineChartContainerTemp) { 
            googleTempLineChart = new google.visualization.LineChart(lineChartContainerTemp); 
            googleTempLineChart.draw(dataGoogleTempLine, {...baseOptionsGoogleLineChart, title: 'Biểu đồ nhiệt độ', vAxis: { ...baseOptionsGoogleLineChart.vAxis, title: 'Nhiệt độ (°C)'}}); 
        } 
        
        dataGooglePressureLine = new google.visualization.DataTable(); 
        dataGooglePressureLine.addColumn('string', 'Thời gian'); 
        dataGooglePressureLine.addColumn('number', 'Nước cấp (bar)'); 
        dataGooglePressureLine.addColumn('number', 'Nước hồi (bar)'); 
        if(lineChartContainerPressure) { 
            googlePressureLineChart = new google.visualization.LineChart(lineChartContainerPressure); 
            googlePressureLineChart.draw(dataGooglePressureLine, {...baseOptionsGoogleLineChart, title: 'Biểu đồ áp suất', vAxis: { ...baseOptionsGoogleLineChart.vAxis, title: 'Áp suất (bar)'}}); 
        } 
    }
    
    const debouncedRedrawCharts = debounce(function() { 
        if (google.visualization && google.visualization.Gauge && google.visualization.LineChart) { 
            const gaugeWidth = getGaugeChartWidth(); 
            const newGaugeOptions = { width: gaugeWidth, height: gaugeWidth * 0.8, minorTicks: 5, animation:{ duration: 0, easing: 'inAndOut' } }; 
            if(googleGaugeTempIn && dataTempInGauge) googleGaugeTempIn.draw(dataTempInGauge, {...optionsGaugeTemp, ...newGaugeOptions}); 
            if(googleGaugePressureIn && dataPressureInGauge) googleGaugePressureIn.draw(dataPressureInGauge, {...optionsGaugePressure, ...newGaugeOptions}); 
            if(googleGaugeTempOut && dataTempOutGauge) googleGaugeTempOut.draw(dataTempOutGauge, {...optionsGaugeTemp, ...newGaugeOptions}); 
            if(googleGaugePressureOut && dataPressureOutGauge) googleGaugePressureOut.draw(dataPressureOutGauge, {...optionsGaugePressure, ...newGaugeOptions}); 
            
            const lineChartContainerTemp = document.getElementById('google_temp_chart_div'); 
            const lineChartContainerPressure = document.getElementById('google_pressure_chart_div'); 
            const newLineChartOptionsForResize = { 
                ...baseOptionsGoogleLineChart, 
                width: lineChartContainerTemp ? lineChartContainerTemp.offsetWidth : 300, 
                animation:{ duration: 0, easing: 'inAndOut', startup: false } 
            }; 
            if(googleTempLineChart && dataGoogleTempLine) googleTempLineChart.draw(dataGoogleTempLine, {...newLineChartOptionsForResize, title: 'Biểu đồ nhiệt độ', vAxis: { ...newLineChartOptionsForResize.vAxis, title: 'Nhiệt độ (°C)'}}); 
            if(googlePressureLineChart && dataGooglePressureLine) googlePressureLineChart.draw(dataGooglePressureLine, {...newLineChartOptionsForResize, title: 'Biểu đồ áp suất', vAxis: { ...newLineChartOptionsForResize.vAxis, title: 'Áp suất (bar)'}}); 
        } 
    }, 250); 
    window.addEventListener('resize', debouncedRedrawCharts);

    function updateLineChartsPeriodically() {
        if (!dataGoogleTempLine || !googleTempLineChart || !dataGooglePressureLine || !googlePressureLineChart) {
            return;
        }
        const currentTimeLabelForLineChart = new Date().toLocaleTimeString('vi-VN', {hour12:false});
        
        const lineChartContainerTemp = document.getElementById('google_temp_chart_div');
        const lineChartContainerPressure = document.getElementById('google_pressure_chart_div');
        
        const currentTempChartWidth = lineChartContainerTemp ? lineChartContainerTemp.offsetWidth : 300;
        const currentPressureChartWidth = lineChartContainerPressure ? lineChartContainerPressure.offsetWidth : 300;

        const dynamicUpdateOptions = {
            ...updateOptionsGoogleLineChart 
        };

        if (dataGoogleTempLine.getNumberOfRows() >= maxDataPointsForLineChart) {
            dataGoogleTempLine.removeRow(0);
        }
        dataGoogleTempLine.addRow([currentTimeLabelForLineChart, latestTempIn, latestTempOut]);
        googleTempLineChart.draw(dataGoogleTempLine, {
            ...dynamicUpdateOptions, 
            width: currentTempChartWidth,
            title: 'Biểu đồ nhiệt độ', 
            vAxis: { ...dynamicUpdateOptions.vAxis, title: 'Nhiệt độ (°C)'}
        });

        if (dataGooglePressureLine.getNumberOfRows() >= maxDataPointsForLineChart) {
            dataGooglePressureLine.removeRow(0);
        }
        dataGooglePressureLine.addRow([currentTimeLabelForLineChart, latestPressureIn, latestPressureOut]);
        googlePressureLineChart.draw(dataGooglePressureLine, {
            ...dynamicUpdateOptions, 
            width: currentPressureChartWidth,
            title: 'Biểu đồ áp suất', 
            vAxis: { ...dynamicUpdateOptions.vAxis, title: 'Áp suất (bar)'}
        });
    }

    // --- ERA IoT Widget Integration ---
    const eraWidget = new EraWidget();
    let configTempIn, configPressureIn, configTempOut, configPressureOut;
    let configPumpState, configCompressorState, configInverterState, configActualInverterFrequency, configActualValvePercentage; 
    let actionsMap = {}; 

    try {
        eraWidget.init({
          needRealtimeConfigs: true,
          needHistoryConfigs: false, 
          needActions: true, 
          maxRealtimeConfigsCount: 9, 
          minRealtimeConfigsCount: 4, 
          maxActionsCount: 8, // 6 cho on/off + 2 cho set giá trị qua action
          minActionsCount: 8, 

          onConfiguration: (configuration) => { 
            if(eraStatusEl) eraStatusEl.textContent = 'Đã kết nối ERA IoT. Đã nhận cấu hình.'; 
            console.log('ERA Widget Configuration:', configuration); 
            configTempIn = configuration.realtime_configs?.[0]; 
            configPressureIn = configuration.realtime_configs?.[1]; 
            configTempOut = configuration.realtime_configs?.[2]; 
            configPressureOut = configuration.realtime_configs?.[3]; 
            configPumpState = configuration.realtime_configs?.[4]; 
            configCompressorState= configuration.realtime_configs?.[5]; 
            configInverterState = configuration.realtime_configs?.[6]; 
            configActualInverterFrequency = configuration.realtime_configs?.[7]; 
            configActualValvePercentage = configuration.realtime_configs?.[8]; 

            if (configuration.actions) { 
                actionsMap.pumpOn = configuration.actions?.[0]; 
                actionsMap.pumpOff = configuration.actions?.[1]; 
                actionsMap.compressorOn = configuration.actions?.[2]; 
                actionsMap.compressorOff = configuration.actions?.[3]; 
                actionsMap.inverterRun = configuration.actions?.[4]; 
                actionsMap.inverterStop = configuration.actions?.[5]; 
                actionsMap.setFrequencyAction = configuration.actions?.[6]; // Action để GỬI lệnh cài đặt tần số
                actionsMap.setValvePercentageAction = configuration.actions?.[7]; // Action để GỬI lệnh cài đặt van
            } 
            [pumpBtn, compressorBtn, inverterBtn].forEach(btn => { if (btn) { const baseId = btn.id.replace('-toggle', ''); const actionOn = actionsMap[baseId + (baseId === 'inverter' ? 'Run' : 'On')]; const actionOff = actionsMap[baseId + (baseId === 'inverter' ? 'Stop' : 'Off')]; if (actionOn && actionOff) { btn.disabled = false; btn.classList.remove('bg-gray-400', 'cursor-not-allowed'); } else { btn.disabled = true; btn.textContent = 'Lỗi Action'; btn.classList.add('bg-gray-400', 'cursor-not-allowed'); } } }); 
            
            // Kích hoạt input và nút submit cho tần số nếu action tương ứng được map
            if (frequencyInput && frequencySubmitBtn) {
                if (actionsMap.setFrequencyAction && actionsMap.setFrequencyAction.action) { 
                     frequencyInput.disabled = false; 
                     frequencySubmitBtn.disabled = false; 
                     frequencySubmitBtn.classList.remove('bg-gray-400', 'cursor-not-allowed'); 
                     frequencySubmitBtn.classList.add('bg-purple-600', 'hover:bg-purple-700'); 
                     frequencySubmitBtn.textContent = 'Gửi giá trị';
                } else {
                     frequencyInput.disabled = true; 
                     frequencySubmitBtn.disabled = true; 
                     frequencySubmitBtn.textContent = 'Lỗi Action'; 
                     frequencySubmitBtn.classList.add('bg-gray-400', 'cursor-not-allowed');
                }
            }
            if (valvePercentageInput && valveSubmitBtn) {
                if (actionsMap.setValvePercentageAction && actionsMap.setValvePercentageAction.action) { 
                    valvePercentageInput.disabled = false;
                    valveSubmitBtn.disabled = false;
                    valveSubmitBtn.classList.remove('bg-gray-400', 'cursor-not-allowed');
                    valveSubmitBtn.classList.add('bg-blue-600', 'hover:bg-blue-700'); 
                    valveSubmitBtn.textContent = 'Gửi giá trị';
                } else {
                    valvePercentageInput.disabled = true;
                    valveSubmitBtn.disabled = true;
                    valveSubmitBtn.textContent = 'Lỗi Action';
                    valveSubmitBtn.classList.add('bg-gray-400', 'cursor-not-allowed');
                }
            }
          },
          onValues: (values) => { 
            console.log('ERA Widget Values:', values);
            const currentTimeLabel = new Date().toLocaleTimeString('vi-VN', {hour12:false}); 
            if (eraStatusEl) eraStatusEl.textContent = `Cập nhật lúc ${currentTimeLabel}`;

            if (configTempIn && values[configTempIn.id] !== undefined) {
              latestTempIn = parseFloat(values[configTempIn.id].value);
              if (googleGaugeTempIn && dataTempInGauge) { dataTempInGauge.setValue(0, 1, latestTempIn); googleGaugeTempIn.draw(dataTempInGauge, optionsGaugeTemp); }
            } else { latestTempIn = 0;  }

            if (configPressureIn && values[configPressureIn.id] !== undefined) {
              latestPressureIn = parseFloat(values[configPressureIn.id].value);
              if (googleGaugePressureIn && dataPressureInGauge) { dataPressureInGauge.setValue(0, 1, latestPressureIn); googleGaugePressureIn.draw(dataPressureInGauge, optionsGaugePressure); }
            } else { latestPressureIn = 0; }

            if (configTempOut && values[configTempOut.id] !== undefined) {
              latestTempOut = parseFloat(values[configTempOut.id].value);
               if (googleGaugeTempOut && dataTempOutGauge) { dataTempOutGauge.setValue(0, 1, latestTempOut); googleGaugeTempOut.draw(dataTempOutGauge, optionsGaugeTemp); }
            } else { latestTempOut = 0; }

            if (configPressureOut && values[configPressureOut.id] !== undefined) {
              latestPressureOut = parseFloat(values[configPressureOut.id].value);
              if (googleGaugePressureOut && dataPressureOutGauge) { dataPressureOutGauge.setValue(0, 1, latestPressureOut); googleGaugePressureOut.draw(dataPressureOutGauge, optionsGaugePressure); }
            } else { latestPressureOut = 0; }
            
            if (configActualInverterFrequency && values[configActualInverterFrequency.id] !== undefined) {
                const rawEraFreqValue = parseFloat(values[configActualInverterFrequency.id].value);
                if (!isNaN(rawEraFreqValue) && currentFrequencyDisplayEl) { 
                    const displayableFreqForShow = (rawEraFreqValue / 100).toFixed(2).replace('.', ',');
                    currentFrequencyDisplayEl.textContent = displayableFreqForShow;
                }
            }
            if (configActualValvePercentage && values[configActualValvePercentage.id] !== undefined) {
                const rawEraValveValue = parseInt(values[configActualValvePercentage.id].value, 10);
                 if (!isNaN(rawEraValveValue) && currentValvePercentageDisplayEl) { 
                    currentValvePercentageDisplayEl.textContent = rawEraValveValue;
                }
            }

            if (configPumpState && values[configPumpState.id] !== undefined) { const pumpIsOn = (values[configPumpState.id].value === 1 || values[configPumpState.id].value === true || String(values[configPumpState.id].value).toLowerCase() === 'on' || String(values[configPumpState.id].value) === '1'); if (pumpLedEl) { pumpLedEl.classList.remove('led-on', 'led-off'); pumpLedEl.classList.add(pumpIsOn ? 'led-on' : 'led-off'); } updateDeviceButtonUI(pumpBtn, values[configPumpState.id].value, 'Bật', 'Tắt'); }
            if (configCompressorState && values[configCompressorState.id] !== undefined) { const compressorIsOn = (values[configCompressorState.id].value === 1 || values[configCompressorState.id].value === true || String(values[configCompressorState.id].value).toLowerCase() === 'on' || String(values[configCompressorState.id].value) === '1'); if (compressorLedEl) { compressorLedEl.classList.remove('led-on', 'led-off'); compressorLedEl.classList.add(compressorIsOn ? 'led-on' : 'led-off'); } updateDeviceButtonUI(compressorBtn, values[configCompressorState.id].value, 'Bật', 'Tắt'); }
            if (configInverterState && values[configInverterState.id] !== undefined) { updateDeviceButtonUI(inverterBtn, values[configInverterState.id].value, 'Run', 'Stop'); }
            
          },
          onError: (error) => { console.error('ERA Widget Error:', error); if(eraStatusEl) eraStatusEl.textContent = 'Lỗi kết nối ERA Widget: ' + error.message; }
        });
    } catch (e) { console.error("Lỗi khởi tạo EraWidget:", e); if(eraStatusEl) { eraStatusEl.textContent = "Lỗi: Widget cần chạy trong ERA IoT. " + e.message; eraStatusEl.classList.add("text-red-500", "font-semibold"); } [pumpBtn, compressorBtn, inverterBtn, frequencyInput, frequencySubmitBtn, valvePercentageInput, valveSubmitBtn].forEach(el => { if(el) { el.disabled = true; el.classList.add('bg-gray-300', 'cursor-not-allowed'); el.classList.remove('bg-red-600', 'bg-green-600', 'bg-purple-600', 'bg-blue-600', 'hover:bg-red-700', 'hover:bg-green-700', 'hover:bg-purple-700', 'hover:bg-blue-700'); if (el.tagName === 'BUTTON') el.textContent = 'Lỗi'; } }); }

    function updateDeviceButtonUI(button, state, onText, offText) { if (!button) return; const baseId = button.id.replace('-toggle', ''); const actionOn = actionsMap[baseId + (baseId === 'inverter' ? 'Run' : 'On')]; const actionOff = actionsMap[baseId + (baseId === 'inverter' ? 'Stop' : 'Off')]; if (!(actionOn && actionOff)) { button.disabled = true; button.textContent = 'Lỗi Action'; button.classList.add('bg-gray-400', 'cursor-not-allowed'); button.classList.remove('bg-red-600', 'hover:bg-red-700', 'focus:ring-red-500', 'bg-green-600', 'hover:bg-green-700', 'focus:ring-green-500'); return; } button.disabled = false; const isActiveState = (state === 1 || state === true || String(state).toLowerCase() === 'on' || String(state).toLowerCase() === 'run' || String(state) === '1'); button.setAttribute('aria-pressed', isActiveState.toString()); button.textContent = isActiveState ? onText : offText; button.classList.remove('bg-red-600', 'hover:bg-red-700', 'focus:ring-red-500', 'bg-green-600', 'hover:bg-green-700', 'focus:ring-green-500', 'bg-gray-400', 'cursor-not-allowed'); if (isActiveState) { button.classList.add('bg-green-600', 'hover:bg-green-700', 'focus:ring-green-500'); } else { button.classList.add('bg-red-600', 'hover:bg-red-700', 'focus:ring-red-500'); } }
    if(pumpBtn) pumpBtn.addEventListener('click', () => { if (pumpBtn.disabled) return; const isCurrentlyOn = pumpBtn.getAttribute('aria-pressed') === 'true'; const actionToTrigger = isCurrentlyOn ? actionsMap.pumpOff : actionsMap.pumpOn; if (actionToTrigger?.action) { eraWidget.triggerAction(actionToTrigger.action, null).then(() => console.log(`Pump action (${isCurrentlyOn ? 'OFF' : 'ON'}) triggered`)).catch(err => console.error(`Error triggering pump action:`, err)); } else { console.error('Pump ON/OFF action not properly configured.'); } });
    if(compressorBtn) compressorBtn.addEventListener('click', () => { if (compressorBtn.disabled) return; const isCurrentlyOn = compressorBtn.getAttribute('aria-pressed') === 'true'; const actionToTrigger = isCurrentlyOn ? actionsMap.compressorOff : actionsMap.compressorOn; if (actionToTrigger?.action) { eraWidget.triggerAction(actionToTrigger.action, null).then(() => console.log(`Compressor action (${isCurrentlyOn ? 'OFF' : 'ON'}) triggered`)).catch(err => console.error(`Error triggering compressor action:`, err)); } else { console.error('Compressor ON/OFF action not properly configured.'); } });
    if(inverterBtn) inverterBtn.addEventListener('click', () => { if (inverterBtn.disabled) return; const isCurrentlyRunning = inverterBtn.getAttribute('aria-pressed') === 'true'; const actionToTrigger = isCurrentlyRunning ? actionsMap.inverterStop : actionsMap.inverterRun; if (actionToTrigger?.action) { eraWidget.triggerAction(actionToTrigger.action, null).then(() => console.log(`Inverter action (${isCurrentlyRunning ? 'STOP' : 'RUN'}) triggered`)).catch(err => console.error(`Error triggering inverter action:`, err)); } else { console.error('Inverter RUN/STOP action not properly configured.');} });
    
    if(frequencyForm) frequencyForm.addEventListener('submit', (event) => { 
        event.preventDefault(); 
        if (frequencySubmitBtn.disabled || !actionsMap.setFrequencyAction || !actionsMap.setFrequencyAction.action) { 
            if(frequencyFeedbackEl) { frequencyFeedbackEl.textContent = 'Chức năng chưa sẵn sàng hoặc lỗi cấu hình Action.'; frequencyFeedbackEl.className = 'text-xs sm:text-sm text-red-600 font-medium'; frequencyFeedbackEl.classList.remove('hidden'); } 
            return; 
        } 
        const inputValue = frequencyInput.value.replace(',', '.'); 
        const displayFreqValue = parseFloat(inputValue); 
        if (isNaN(displayFreqValue) || displayFreqValue < 0 || displayFreqValue > 50) { 
            if(frequencyFeedbackEl) { frequencyFeedbackEl.textContent = 'Vui lòng nhập tần số hợp lệ từ 0,00 đến 50,00 Hz.'; frequencyFeedbackEl.className = 'text-xs sm:text-sm text-red-600 font-medium'; frequencyFeedbackEl.classList.remove('hidden'); } 
            return; 
        } 
        const scaledFreqValueForEra = Math.round(displayFreqValue * 100); 
        if(frequencyFeedbackEl) { frequencyFeedbackEl.textContent = ''; frequencyFeedbackEl.className = 'text-xs sm:text-sm text-gray-600 font-medium'; frequencyFeedbackEl.classList.remove('hidden'); } 
        
        console.log("Gửi tần số:", { value: scaledFreqValueForEra }, "tới Action ID:", actionsMap.setFrequencyAction.action);
        eraWidget.triggerAction(actionsMap.setFrequencyAction.action, null, { value: scaledFreqValueForEra }) 
            .then(() => { 
                const formattedDisplayFreq = displayFreqValue.toFixed(2).replace('.', ','); 
                if(frequencyFeedbackEl) { frequencyFeedbackEl.textContent = `Đã gửi lệnh cài đặt tần số: ${formattedDisplayFreq} Hz`; frequencyFeedbackEl.className = 'text-xs sm:text-sm text-green-600 font-medium'; } 
            })
            .catch(err => { 
                if(frequencyFeedbackEl) { frequencyFeedbackEl.textContent = 'Lỗi khi gửi lệnh cài đặt tần số.'; frequencyFeedbackEl.className = 'text-xs sm:text-sm text-red-600 font-medium'; } 
                console.error('Error triggering set frequency action:', err); 
            }); 
    });
    
    if(valveForm) valveForm.addEventListener('submit', (event) => {
        event.preventDefault();
        if (valveSubmitBtn.disabled || !actionsMap.setValvePercentageAction || !actionsMap.setValvePercentageAction.action) {
            if(valveFeedbackEl) {
                valveFeedbackEl.textContent = 'Chức năng chưa sẵn sàng hoặc lỗi cấu hình Action.';
                valveFeedbackEl.className = 'text-xs sm:text-sm text-red-600 font-medium';
                valveFeedbackEl.classList.remove('hidden');
            }
            return;
        }

        const percentageValue = parseInt(valvePercentageInput.value, 10);

        if (isNaN(percentageValue) || percentageValue < 0 || percentageValue > 100) {
            if(valveFeedbackEl) {
                valveFeedbackEl.textContent = 'Vui lòng nhập tỷ lệ từ 0 đến 100%.';
                valveFeedbackEl.className = 'text-xs sm:text-sm text-red-600 font-medium';
                valveFeedbackEl.classList.remove('hidden');
            }
            return;
        }
        if(valveFeedbackEl) {
            valveFeedbackEl.textContent = '';
            valveFeedbackEl.className = 'text-xs sm:text-sm text-gray-600 font-medium';
            valveFeedbackEl.classList.remove('hidden');
        }

        const payload = { value: percentageValue }; 
        console.log("Đang gửi payload cho van điện:", payload, "tới Action ID:", actionsMap.setValvePercentageAction.action); 

        eraWidget.triggerAction(actionsMap.setValvePercentageAction.action, null, payload) 
            .then(() => {
                if(valveFeedbackEl) {
                    valveFeedbackEl.textContent = `Đã gửi lệnh cài đặt van: ${percentageValue}%`;
                    valveFeedbackEl.className = 'text-xs sm:text-sm text-green-600 font-medium';
                }
            })
            .catch(err => {
                if(valveFeedbackEl) {
                    valveFeedbackEl.textContent = 'Lỗi khi gửi lệnh cài đặt van.';
                    valveFeedbackEl.className = 'text-xs sm:text-sm text-red-600 font-medium';
                }
                console.error('Error triggering set valve percentage action:', err);
            });
    });
  </script>
</body>
</html>
